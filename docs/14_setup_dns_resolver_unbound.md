<h1 align="center">Setup DNS Resolver Unbound</h1>

```bash
# edit docker-compose.yml file
vim /opt/mailserver/docker-compose.yml
-------------------
...
#
### === Unbound Container ===
#
  unbound:
    image: madnuttah/unbound:latest
    container_name: unbound
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - UNBOUND_UID=1000
      - UNBOUND_GID=1000
#    volumes:
#       - ./data/unbound/config/unbound.conf:/usr/local/unbound/unbound.conf:rw
#       - ./data/unbound/config/healthcheck.sh:/usr/local/unbound/sbin/healthcheck.sh:ro
    healthcheck:
      test: /usr/local/unbound/sbin/healthcheck.sh
      interval: 60s
      retries: 5
      start_period: 15s
      timeout: 30s
    networks:
      mailserverNet:
        ipv4_address: ${IPV4_NETWORK:-172.26.10}.254
        #ipv6_address: ${IPV6_NETWORK:-fd4d:6169:6c63:6f77}::10
---------------------------

# create folders
cd /opt/mailserver
mkdir -p ./data/unbound/{config,log.d}
tree -L 3 -d /opt/mailserver

# run docker container und copy | apjust unbound.conf file
cd /opt/mailserver
docker-compose up -d
docker cp unbound://usr/local/unbound/unbound.conf ./data/unbound/config/unbound.conf

sed -i -e 's/interface: 0.0.0.0@5335/interface: 0.0.0.0@53/' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e 's+access-control: 0.0.0.0/0+#access-control: 0.0.0.0/0+' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e '/#access-control: 0.0.0.0/a\        access-control: fe80::/10 allow' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e '/#access-control: 0.0.0.0/a\        access-control: fc00::/7 allow' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e '/#access-control: 0.0.0.0/a\        access-control: 192.168.0.0/16 allow' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e '/#access-control: 0.0.0.0/a\        access-control: 172.16.0.0/12 allow' /opt/mailserver/data/unbound/config/unbound.conf
sed -i -e '/#access-control: 0.0.0.0/a\        access-control: 10.0.0.0/8 allow' /opt/mailserver/data/unbound/config/unbound.conf
egrep -v '(^.*#|^$)' /opt/mailserver/data/unbound/config/unbound.conf

# copy | edit Script healthcheck.sh 
docker cp unbound:/usr/local/unbound/sbin/healthcheck.sh /opt/mailserver/data/unbound/config/healthcheck.sh
sed -i -e '/PORT="5335"/c\PORT="53"' /opt/mailserver/data/unbound/config/healthcheck.sh
cat /opt/mailserver/data/unbound/config/healthcheck.sh
chmod 0755 /opt/mailserver/data/unbound/config/healthcheck.sh

# edit docker-compose.yml file
vim /opt/mailserver/docker-compose.yml
---------------------------------
...
  mailserver:
..
    depends_on:
      unbound:
        condition: service_started
        # condition: service_healthy
...
    dns:
      - ${IPV4_NETWORK:-172.26.10}.254
    networks:
...
  unbound:
...
    volumes:
      - ./data/unbound/config/unbound.conf:/usr/local/unbound/unbound.conf:rw
      - ./data/unbound/config/healthcheck.sh:/usr/local/unbound/sbin/healthcheck.sh:ro
...
--------------------------------

# restart docker container
cd /opt/mailserver 
docker-compose down && docker-compose up -d
docker-compose logs mailserver


### Test whether DNS resolution works
# in Unbound Docker Container
docker-compose exec unbound sh
-------------------------
/ $ drill google.com
;; ->>HEADER<<- opcode: QUERY, rcode: NOERROR, id: 34865
;; flags: qr rd ra ; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;; google.com.  IN      A

;; ANSWER SECTION:
google.com.     40      IN      A       142.250.179.142
------------------

# in mailserver Docker Container
docker-compose exec mailserver bash
cat /etc/resolv.conf
--------------------------
# Generated by Docker Engine.
# This file can be edited; Docker Engine will not make further changes once it
# has been modified.

nameserver 127.0.0.11
search invalid
options ndots:0

# Based on host file: '/etc/resolv.conf' (internal resolver)
# ExtServers: [172.26.10.254]
# Overrides: [nameservers]
# Option ndots from: internal
----------------------

nslookup google.com
-----------------------
Server:         127.0.0.11
Address:        127.0.0.11#53

Non-authoritative answer:
Name:   google.com
Address: 142.251.36.46
Name:   google.com
Address: 2a00:1450:400e:810::200e
---------------------
exit

# from the host via Unbound Docker Container
docker-compose exec mailserver dig @unbound +short gmail.com MX
docker-compose exec mailserver dig @unbound +short myfirma.de A
docker-compose exec mailserver dig @unbound +short myfirma.de MX
docker-compose exec mailserver dig @unbound +short chip.de MX
docker compose exec mailserver dig @unbound +short gmail.com MX


# test unbound config
docker exec -ti unbound unbound-checkconf

```
